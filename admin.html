<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦é©—å®¤å¾Œå°ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
        // 1. Supabase åˆå§‹åŒ–
        const supabaseUrl = "https://uyvyxkrikmdyypppqsdt.supabase.co"; 
        const supabaseKey = "sb_publishable_AR5cKUsnsxgFRcC1rDCWlQ_mYRrxVUC"; 

        const { createClient } = supabase;
        const _supabase = createClient(supabaseUrl, supabaseKey);

        window.dbOps = {
            fetch: async (col) => {
                const { data, error } = await _supabase.from('lab_content').select('*').eq('collection', col).order('created_at', { ascending: false });
                if (error) { console.error(error); return []; }
                return data.map(r => ({ id: r.id, ...r.data }));
            },
            save: async (col, item) => {
                const isNew = !item.id;
                const payload = { collection: col, data: { ...item, updatedAt: Date.now() } };
                if (isNew) {
                    return await _supabase.from('lab_content').insert(payload);
                } else {
                    const { id, ...cleanItem } = item;
                    return await _supabase.from('lab_content').update({ data: cleanItem }).eq('id', id);
                }
            },
            delete: async (id) => {
                return await _supabase.from('lab_content').delete().eq('id', id);
            }
        };

        // SQL åˆå§‹åŒ–æç¤º
        console.log(`
            %c ğŸ—„ï¸ Supabase è³‡æ–™è¡¨è¨­å®šå»ºè­° %c
            åœ¨ Supabase SQL Editor åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š
            
            create table lab_content (
              id uuid default gen_random_uuid() primary key,
              created_at timestamp with time zone default now(),
              collection text not null,
              data jsonb not null
            );
            
            alter table lab_content enable row level security;
            create policy "Public Access" on lab_content for all using (true) with check (true);
        `, "color: white; background: #3b82f6; padding: 4px 8px; border-radius: 4px;", "color: inherit;");
    </script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const AdminApp = () => {
            const [isLogin, setIsLogin] = useState(false);
            const [tab, setTab] = useState('news');
            const [data, setData] = useState([]);
            const [editing, setEditing] = useState(null);

            const load = async () => {
                const list = await window.dbOps.fetch(tab);
                setData(list);
            };

            useEffect(() => { if(isLogin) load(); }, [isLogin, tab]);

            const handleSave = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const obj = Object.fromEntries(formData.entries());
                if (editing?.id) obj.id = editing.id;
                
                await window.dbOps.save(tab, obj);
                setEditing(null);
                load();
            };

            if (!isLogin) return (
                <div className="min-h-screen flex items-center justify-center">
                    <form onSubmit={(e) => { e.preventDefault(); if(e.target.pw.value === '0701') setIsLogin(true); }} className="bg-white p-8 rounded-xl shadow-lg border">
                        <h2 className="text-xl font-bold mb-4">ç®¡ç†å“¡ç™»å…¥</h2>
                        <input name="pw" type="password" className="border p-2 w-full mb-4 rounded" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
                        <button className="w-full bg-blue-600 text-white py-2 rounded font-bold">ç™»å…¥</button>
                    </form>
                </div>
            );

            return (
                <div className="flex min-h-screen">
                    <div className="w-64 bg-slate-800 text-white p-6">
                        <h1 className="text-xl font-bold mb-10">å¾Œå°ç®¡ç†</h1>
                        <div className="space-y-2">
                            {['news', 'members', 'projects'].map(t => (
                                <button key={t} onClick={() => setTab(t)} className={`w-full text-left px-4 py-2 rounded transition-colors ${tab === t ? 'bg-blue-600' : 'hover:bg-slate-700'}`}>{t === 'news' ? 'æœ€æ–°æ¶ˆæ¯' : t === 'members' ? 'æˆå“¡ç®¡ç†' : 'è¨ˆç•«ç®¡ç†'}</button>
                            ))}
                        </div>
                    </div>
                    <div className="flex-grow p-10">
                        <div className="flex justify-between items-center mb-8">
                            <h2 className="text-2xl font-bold uppercase">{tab}</h2>
                            <button onClick={() => setEditing({})} className="bg-green-600 text-white px-4 py-2 rounded">+ æ–°å¢é …ç›®</button>
                        </div>

                        <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                            <table className="w-full text-left">
                                <thead className="bg-slate-50 border-b">
                                    <tr>
                                        <th className="p-4">å…§å®¹</th>
                                        <th className="p-4">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.map(item => (
                                        <tr key={item.id} className="border-b hover:bg-slate-50">
                                            <td className="p-4">
                                                <div className="font-bold">{item.title || item.name}</div>
                                                <div className="text-sm text-slate-500">{item.date || item.year}</div>
                                            </td>
                                            <td className="p-4 space-x-4">
                                                <button onClick={() => setEditing(item)} className="text-blue-600">ç·¨è¼¯</button>
                                                <button onClick={async () => { if(confirm('åˆªé™¤ï¼Ÿ')){ await window.dbOps.delete(item.id); load(); } }} className="text-red-600">åˆªé™¤</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {editing && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4">
                            <form onSubmit={handleSave} className="bg-white p-8 rounded-2xl w-full max-w-md shadow-2xl">
                                <h3 className="text-xl font-bold mb-6">{editing.id ? 'ç·¨è¼¯' : 'æ–°å¢'}é …ç›®</h3>
                                <div className="space-y-4">
                                    <input name={tab === 'members' ? 'name' : 'title'} defaultValue={editing.name || editing.title} placeholder="æ¨™é¡Œ/å§“å" className="w-full border p-2 rounded" required />
                                    {tab === 'news' && <input name="date" type="date" defaultValue={editing.date} className="w-full border p-2 rounded" required />}
                                    {tab === 'members' && (
                                        <>
                                            <input name="year" defaultValue={editing.year} placeholder="å¹´ç´š (e.g. ç¢©ä¸€)" className="w-full border p-2 rounded" />
                                            <select name="type" defaultValue={editing.type} className="w-full border p-2 rounded">
                                                <option value="master">ç¢©å£«ç”Ÿ</option>
                                                <option value="pi">æŒ‡å°æ•™æˆ</option>
                                                <option value="alumni">ç•¢æ¥­æ ¡å‹</option>
                                            </select>
                                        </>
                                    )}
                                    <textarea name={tab === 'members' ? 'research' : 'desc'} defaultValue={editing.research || editing.desc} placeholder="ç ”ç©¶æ–¹å‘æˆ–èªªæ˜" className="w-full border p-2 rounded h-24" />
                                </div>
                                <div className="flex justify-end gap-4 mt-8">
                                    <button type="button" onClick={() => setEditing(null)} className="px-4 py-2 border rounded">å–æ¶ˆ</button>
                                    <button className="px-4 py-2 bg-blue-600 text-white rounded font-bold">å„²å­˜</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>