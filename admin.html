<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦é©—å®¤å¾Œå°ç®¡ç†ç³»çµ± (Admin Dashboard)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 1. Fallback Logic -->
    <script>
        window.isLocal = true;
        const checkQuota = (data) => {
            try { if (JSON.stringify(data).length > 4500000) throw new Error("æœ¬æ©Ÿå„²å­˜ç©ºé–“å·²æ»¿ (5MB)ã€‚è«‹åˆ‡æ›è‡³ Supabase é›²ç«¯æ¨¡å¼ã€‚"); } catch(e) { throw e; }
        };

        window.enableLocalMode = () => {
            console.log("Initializing Local Mode...");
            window.isLocal = true;
            const getLocal = (key) => {
                try { return JSON.parse(localStorage.getItem('smsmp_' + key) || '[]'); } catch (e) { return []; }
            };
            const setLocal = (key, data) => {
                checkQuota(data);
                localStorage.setItem('smsmp_' + key, JSON.stringify(data));
            };

            window.dbOps = {
                signIn: async () => true,
                onAuth: (cb) => { setTimeout(() => cb({ uid: 'local-admin' }), 50); return () => {}; },
                fetch: async (colName) => getLocal(colName),
                add: async (colName, data) => {
                    const list = getLocal(colName);
                    const newItem = { ...data, id: 'loc_' + Date.now(), createdAt: Date.now() };
                    setLocal(colName, [newItem, ...list]);
                    return newItem;
                },
                update: async (colName, id, data) => {
                    const list = getLocal(colName);
                    const idx = list.findIndex(i => i.id === id);
                    if (idx !== -1) {
                        list[idx] = { ...list[idx], ...data };
                        setLocal(colName, list);
                    }
                },
                delete: async (colName, id) => {
                    const list = getLocal(colName);
                    setLocal(colName, list.filter(i => i.id !== id));
                },
                batchAdd: async (colName, items) => {
                    const list = getLocal(colName);
                    const newItems = items.map((item, idx) => ({ ...item, id: 'batch_' + Date.now() + '_' + idx, createdAt: Date.now() - idx * 100 }));
                    setLocal(colName, [...newItems, ...list]);
                },
                initDefaults: async (defaultData) => {
                    for (const [key, items] of Object.entries(defaultData)) {
                        if (getLocal(key).length === 0) {
                            const newItems = items.map((i, idx) => ({ ...i, id: `init_${idx}`, createdAt: Date.now() - (idx * 1000) }));
                            setLocal(key, newItems);
                        }
                    }
                }
            };
        };
        window.enableLocalMode();
    </script>

    <!-- 2. Supabase Logic -->
    <script type="module">
        const supabaseUrl = "https://uyvyxkrikmdyypppqsdt.supabase.co"; 
        const supabaseKey = "sb_publishable_AR5cKUsnsxgFRcC1rDCWlQ_mYRrxVUC"; 

        // SQL å»ºè¡¨æŒ‡ä»¤ (éŒ¯èª¤æ™‚æç¤ºç”¨)
        const SETUP_SQL = `
-- è«‹è¤‡è£½ä»¥ä¸‹ SQL æŒ‡ä»¤ä¸¦åœ¨ Supabase SQL Editor åŸ·è¡Œï¼š
create table if not exists lab_content (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default now(),
  collection text not null,
  data jsonb not null
);

alter table lab_content enable row level security;
create policy "Allow All Access" on lab_content for all using (true) with check (true);
-------------------------------------------------------
`;

        const handleError = (error) => {
            console.error("Supabase Error:", error);
            if (error.code === 'PGRST205') {
                alert("âš ï¸ è³‡æ–™åº«éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™è¡¨ 'lab_content'ã€‚\n\nè«‹æ‰“é–‹ç€è¦½å™¨ Console (F12)ï¼Œè¤‡è£½æˆ‘å¹«æ‚¨æº–å‚™å¥½çš„ SQL æŒ‡ä»¤ï¼Œä¸¦åˆ° Supabase SQL Editor åŸ·è¡Œã€‚");
                console.log("%câ–¼â–¼â–¼ è«‹è¤‡è£½ä»¥ä¸‹ SQL æŒ‡ä»¤ä¸¦åˆ° Supabase åŸ·è¡Œ â–¼â–¼â–¼", "color: yellow; font-size: 16px; font-weight: bold;");
                console.log(SETUP_SQL);
                return [];
            }
            throw error;
        };

        try {
            if (supabaseKey.includes("è«‹åœ¨æ­¤å¡«å…¥")) {
               console.warn("Supabase Key missing, using Local Mode");
            } else {
                const { createClient } = supabase;
                const _supabase = createClient(supabaseUrl, supabaseKey);
                
                window.isLocal = false;
                window.dbOps = {
                    signIn: async () => true, 
                    onAuth: (cb) => { cb({ uid: 'supabase-admin' }); return () => {}; },
                    
                    fetch: async (colName) => {
                        const { data, error } = await _supabase
                            .from('lab_content')
                            .select('id, data')
                            .eq('collection', colName)
                            .order('created_at', { ascending: false })
                            .limit(100);
                        if (error) return handleError(error);
                        return data.map(row => ({ id: row.id, ...row.data }));
                    },
                    
                    add: async (colName, data) => {
                        const { error } = await _supabase
                            .from('lab_content')
                            .insert({ collection: colName, data: { ...data, createdAt: Date.now() } });
                        if (error) handleError(error);
                    },
                    
                    update: async (colName, id, data) => {
                        const { error } = await _supabase
                            .from('lab_content')
                            .update({ data: { ...data } })
                            .eq('id', id);
                        if (error) handleError(error);
                    },
                    
                    delete: async (colName, id) => {
                        const { error } = await _supabase
                            .from('lab_content')
                            .delete()
                            .eq('id', id);
                        if (error) handleError(error);
                    },
                    
                    batchAdd: async (colName, items) => {
                        const rows = items.map(item => ({
                            collection: colName,
                            data: { ...item, createdAt: item.createdAt || Date.now() }
                        }));
                        const { error } = await _supabase.from('lab_content').insert(rows);
                        if (error) handleError(error);
                    },

                    initDefaults: async (defaultData) => {
                        for (const [key, items] of Object.entries(defaultData)) {
                            // Check count first to avoid duplicates
                            const { count, error } = await _supabase
                                .from('lab_content')
                                .select('*', { count: 'exact', head: true })
                                .eq('collection', key);
                            
                            if (error) {
                                handleError(error);
                                return;
                            }
                            
                            if (count === 0) {
                                const rows = items.map((item, idx) => ({
                                    collection: key,
                                    data: { ...item, id: `init_${idx}`, createdAt: Date.now() - idx * 1000 }
                                }));
                                const { error: insertError } = await _supabase.from('lab_content').insert(rows);
                                if (insertError) handleError(insertError);
                            }
                        }
                    }
                };
                console.log("âš¡ Supabase Connected");
            }
        } catch (e) {
            console.warn("âš ï¸ Supabase failed, using Local Mode", e);
        }
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, Component } = React;
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) return <div className="p-10 text-center">ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ•´é é¢ã€‚</div>;
                return this.props.children;
            }
        }

        const getCredentials = () => ({ username: localStorage.getItem('smsmp_admin_user') || 'Yflin', password: localStorage.getItem('smsmp_admin_pass') || '0701' });

        // â˜…â˜…â˜… Real Data â˜…â˜…â˜…
        const defaultData = {
            news: [
                { date: "2025-11-06", title: "114å¹´ å°ç£ç²¾å¯†å·¥ç¨‹å­¸æœƒâ€§æ±å°é›†åœ˜ã€ç²¾å¯†å·¥ç¨‹å°ˆé¡Œèˆ‡è«–æ–‡çã€‘ï¼Œæ¦®ç²ç ”ç©¶è«–æ–‡çä½³ä½œ", tag: "Award" },
                { date: "2025-11-06", title: "114å¹´ å°ç£ç²¾å¯†å·¥ç¨‹å­¸æœƒâ€§æ±å°é›†åœ˜ã€ç²¾å¯†å·¥ç¨‹å°ˆé¡Œèˆ‡è«–æ–‡çã€‘ï¼Œæ¦®ç²å¤§å°ˆå°ˆé¡Œçä½³ä½œ", tag: "Award" },
                { date: "2025-06-18", title: "114å¹´å°ä¸­ç²¾æ©Ÿç›ƒ CNCç¬¬ä¸‰å±†å…¨åœ‹å¤šè»¸æ©Ÿçµ„æŠ€èƒ½ç«¶è³½ï¼Œæ¦®ç²ç¬¬å…­å", tag: "Award" },
                { date: "2024-06-02", title: "113å¹´å°ä¸­ç²¾æ©Ÿç›ƒ CNCç¬¬äºŒå±†å…¨åœ‹å¤šè»¸æ©ŸæŠ€èƒ½ç«¶è³½ï¼Œæ¦®ç²ç¬¬ä¸‰å", tag: "Award" },
                { date: "2023-12-01", title: "2023å¹´ä¸­åœ‹æ©Ÿæ¢°å·¥ç¨‹å­¸æœƒç¬¬40å±†å…¨åœ‹å­¸è¡“ç ”è¨æœƒæš¨å­¸ç”Ÿè«–æ–‡ç™¼è¡¨ç«¶è³½ï¼Œæ¦®ç²åœ‹ç§‘æœƒæ©Ÿæ¢°å›ºåŠ›èˆ‡ç†±æµå­¸é–€ç¬¬ä¸‰å", tag: "Award" },
                { date: "2023-10-28", title: "2023å¹´ã€CTTT 2023 ç¬¬å…­å±†è‡ºç£ç£¨æ½¤ç§‘æŠ€ç ”è¨æœƒã€ï¼Œæ¦®ç²ç‰¹åˆ¥ç", tag: "Award" },
                { date: "2023-10-14", title: "2023å¹´ç¬¬åäºŒå±†ä¸­èˆˆå¤§å­¸ã€ç²¾å¯†å·¥å…·æ©Ÿèˆ‡æ™ºæ…§åŒ–æŠ€è¡“ã€å°ˆé¡Œä½œç«¶è³½ï¼Œæ¦®ç²å…¨åœ‹ç¬¬äºŒå", tag: "Award" },
                { date: "2023-04-28", title: "2023å¹´ã€ISMEç¬¬å…«å±†å°ç£æ©Ÿé›»å·¥ç¨‹åœ‹éš›å­¸æœƒå…¨åœ‹å­¸è¡“ç ”è¨æœƒã€ï¼Œæ¦®ç²å…ˆé€²è¤‡åˆææ–™è«–å£‡æœ€ä½³è«–æ–‡ç", tag: "Award" },
                { date: "2023-04-16", title: "112å¹´ã€å°ä¸­ç²¾æ©Ÿç›ƒCNCå¤šè»¸æ©ŸæŠ€èƒ½ç«¶è³½ã€ï¼Œæ¦®ç²å…¨åœ‹ç¬¬ä¸ƒå", tag: "Award" },
                { date: "2020-11-20", title: "2020å¹´æ™ºæ…§æ©Ÿæ¢° SMB APP ç«¶è³½ï¼Œæ¦®ç²ä½³ä½œ", tag: "Award" },
                { date: "2020-11-07", title: "2020å¹´ã€å…¨åœ‹ç£¨æ½¤ç§‘æŠ€å¯¦å‹™æŠ€è¡“ç«¶è³½ã€ï¼Œæ¦®ç²æœ€ä½³æŠ€è¡“å‘ˆç¾ç", tag: "Award" },
                { date: "2020-10-15", title: "2020å¹´ã€å…¨åœ‹ä¸‰è±é›»æ©ŸCNCæ™ºèƒ½APPå‰µæ„é–‹ç™¼ç«¶è³½ã€ï¼Œæ¦®ç²ç¬¬ä¸€å", tag: "Award" },
                { date: "2020-09-26", title: "2020å¹´ç¬¬ä¹å±†ä¸­èˆˆå¤§å­¸ã€ç²¾å¯†å·¥å…·æ©Ÿèˆ‡æ™ºæ…§åŒ–æŠ€è¡“ã€å°ˆé¡Œå¯¦ä½œç«¶è³½ï¼Œæ¦®ç²ç¬¬äºŒå", tag: "Award" },
                { date: "2020-08-28", title: "2020å¹´å°ç£å·¥ç¨‹åœ‹éš›å­¸æœƒå…¨åœ‹å­¸è¡“ç ”è¨æœƒç¦æ˜Ÿç†±èƒ½å‰µæ„ç«¶è³½ï¼Œæ¦®ç²ä½³ä½œ", tag: "Award" }
            ],
            projects: [
                { type: "patent", year: "2024/04/21", title: "æ™¶éŒ åˆ‡å‰²è£ç½®", agency: "I840267", role: "ç™¼æ˜äºº: æ—å²³é‹’ã€è”¡æ˜ç¾©ã€åš´ä»•è‚²ã€åŠ‰è“å§" },
                { type: "patent", year: "2021/10/11", title: "è‡ªå‹•æ“ è†æ‹‹å…‰åˆ€æŠŠ", agency: "I742924", role: "ç™¼æ˜äºº: è”¡æ˜ç¾©ã€éƒ­ä¿ŠéºŸã€æ—å²³é‹’ã€é»ƒå®ˆæ­£" },
                { type: "patent", year: "2021/06/01", title: "è‡ªå‹•å°åˆ€è£ç½®ä»¥åŠç£¨åºŠ", agency: "M612712", role: "ç™¼æ˜äºº: è”¡æ˜ç¾©ã€æ—å²³é‹’ã€é™³ä¿Šå»¶" },
                { type: "patent", year: "2019/04/21", title: "å¯èª¿å¼å£“å½ˆç°§åˆ€æŠŠ", agency: "I656941", role: "ç™¼æ˜äºº: è”¡æ˜ç¾©ã€éƒ­ä¿ŠéºŸã€æ—å²³é‹’" },
                { type: "government", year: "114/06/01-115/05/31", title: "é«˜é•·å¾‘æ¯”æ¸›æŒ¯è»Šåˆ€æ¡¿è¨­è¨ˆèˆ‡æ™ºèƒ½æªå­”åŠ å·¥åƒæ•¸å„ªåŒ–ç³»çµ±é–‹ç™¼", agency: "NSTC-114-2622-E-167-003", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "government", year: "113/08/01-114/07/31", title: "æ‡‰ç”¨å€’å‚³éé¡ç¥ç¶“ç¶²è·¯çµåˆè¶…éŸ³æ³¢éœ‡å‹•è¼”åŠ©èˆ‡è¨Šè™Ÿæ“·å–åˆ†ææŠ€è¡“æ–¼å¾®éŠ‘å‰ŠåŠ å·¥å–®æ™¶ç¢³åŒ–çŸ½æ™¶ç¢‡ä¹‹ç ”ç©¶", agency: "NSTC-113-2221-E-167-027", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "government", year: "113/02/01-114/01/31", title: "é›£åˆ‡å‰ŠåŠ å·¥æŠ€è¡“èˆ‡è£½ç¨‹é–‹ç™¼ç”¢å­¸è¯ç›Ÿ(3/3)", agency: "NSTC-113-2622-8-167-001-TE3", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "government", year: "112/06/01-113/05/31", title: "é«˜é•·å¾‘æ¯”(L/D=12)æ¸›éœ‡åˆ€æ¡¿è¨­è¨ˆé–‹ç™¼", agency: "NSTC-112-2622-E-167-003", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "government", year: "112/02/01-113/01/31", title: "é›£å‰ŠæåŠ å·¥æŠ€è¡“èˆ‡è£½ç¨‹é–‹ç™¼ç”¢å­¸è¯ç›Ÿ(2/3)", agency: "NSTC-112-2622-8-167-001-TE3", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "industry", year: "114/02/14 ~ 114/11/30", title: "æ¶²éœå£“ç£¨åºŠä¹‹AIè‡ªé©æ‡‰åŠ å·¥åƒæ•¸å„ªåŒ–èˆ‡æ™ºæ…§åˆ€å…·ç£¨æè£œå„Ÿç³»çµ±é–‹ç™¼", agency: "å¤§å…‰é•·æ¦®æ©Ÿæ¢°", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "industry", year: "114/02/14 ~ 114/11/30", title: "æ™ºæ…§å¤šè»¸å·¥å…·æ©ŸåŠ å·¥èƒ½æ•ˆç®¡ç†èˆ‡å…§è—å¼ä¸»è»¸å†·å»æŠ€è¡“å„ªåŒ–ç ”ç©¶", agency: "å‡±æŸç²¾å¯†æ©Ÿæ¢°", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "industry", year: "113/09/01 ~ 114/05/31", title: "é©ç”¨æ–¼å°è–„æ™¶ç‰‡ä¹‹é«˜å–ç‰‡è‰¯ç‡é ‚é‡çµ„é–‹ç™¼è¨ˆç•«", agency: "è±ªå³°ç§‘æŠ€", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "industry", year: "113/06/01 ~ 114/05/31", title: "ç·šåˆ‡å‰²é«˜æ•ˆç¯€èƒ½ç”¢ç·šè¦åŠƒåŠé©—è­‰", agency: "ç«‹æ³‰ç·šåˆ‡å‰²", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "industry", year: "113/05/01 ~ 113/12/31", title: "åŠå°é«”åœ‹éš›é€£çµå‰µæ–°è³¦èƒ½è¨ˆåŠƒ", agency: "å°ç£å¹³å¦åŒ–æ‡‰ç”¨æŠ€è¡“å”æœƒ", role: "è¨ˆç•«ä¸»æŒäºº" }
            ],
            members: [
                { type: 'pi', name: "æ—å²³é‹’ (Dr. Yan-Fa Lin)", year: "", research: "å‰µæ–°é«˜æ•ˆèƒ½åŠ å·¥, ç ”ç£¨/æ‹‹å…‰åŠ å·¥æŠ€è¡“é–‹ç™¼", researchDetail: "æ—å²³é‹’å‰¯æ•™æˆç¾ä»»åœ‹ç«‹å‹¤ç›Šç§‘æŠ€å¤§å­¸æ©Ÿæ¢°å·¥ç¨‹ç³»å‰¯ä¸»ä»»...", email: "yflin@ncut.edu.tw", phone: "04-23924505 åˆ†æ©Ÿ 7173", awards: "å¼·èª¿ã€Œå¯¦æ©Ÿæ“ä½œå°å‘ã€...", photo: "391692351_7466255803389344_4203488068870191778_n.jpg", pdfs: [] }
            ],
            gallery: [],
            publications: []
        };
        
        const TAB_NAMES = { news: 'æœ€æ–°æ¶ˆæ¯', projects: 'æ­·å¹´è¨ˆç•«', members: 'æˆå“¡ç®¡ç†', publications: 'ç™¼è¡¨è«–æ–‡', gallery: 'ç”Ÿæ´»å¯«çœŸ' };
        
        const FolderIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-16 h-16 text-yellow-400 mb-2 drop-shadow-sm group-hover:scale-110 transition-transform">
                <path d="M19.5 21a3 3 0 0 0 3-3v-4.5a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3V18a3 3 0 0 0 3 3h15ZM1.5 10.146V6a3 3 0 0 1 3-3h5.379a2.25 2.25 0 0 1 1.59.659l2.122 2.121c.14.141.331.22.53.22H19.5a3 3 0 0 1 3 3v1.146A4.483 4.483 0 0 0 19.5 9h-15a4.483 4.483 0 0 0-3 1.146Z" />
            </svg>
        );

        // --- Aggressive Image Compressor ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Aggressive Downscale: Max 600px
                        const MAX_SIZE = 600;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Aggressive Compression: 0.5 Quality
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const LoginForm = ({ onLogin }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [err, setErr] = useState('');
            const [localMode, setLocalMode] = useState(window.isLocal);
            useEffect(() => { const i = setInterval(() => setLocalMode(window.isLocal), 500); return () => clearInterval(i); }, []);
            const handleSubmit = (e) => {
                e.preventDefault();
                const creds = getCredentials();
                if (u === creds.username && p === creds.password) onLogin();
                else setErr('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm border border-slate-200">
                        <h2 className="text-xl font-bold mb-6 text-center text-slate-800">å¾Œå°ç™»å…¥</h2>
                        <div className={`mb-4 text-xs p-2 rounded flex items-center ${localMode ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                            <span className="mr-2">{localMode ? 'âš ï¸' : 'âœ…'}</span> 
                            <span>{localMode ? 'æœ¬æ©Ÿæ¨¡å¼ (è³‡æ–™åº«æœªé€£ç·š)' : 'å·²é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«'}</span>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full border p-2 rounded" placeholder="å¸³è™Ÿ" value={u} onChange={e=>setU(e.target.value)} required />
                            <input className="w-full border p-2 rounded" type="password" placeholder="å¯†ç¢¼" value={p} onChange={e=>setP(e.target.value)} required />
                            {err && <p className="text-red-500 text-center text-sm">{err}</p>}
                            <button className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition-colors">ç™»å…¥</button>
                        </form>
                    </div>
                </div>
            );
        };

        const EditorModal = ({ activeTab, initData, onSave, onBatchSave, onClose }) => {
            const [formData, setFormData] = useState({});
            const [galleryImages, setGalleryImages] = useState([]);
            const [coverIndex, setCoverIndex] = useState(0);
            const [customInput, setCustomInput] = useState({ year: false, role: false, classYear: false, yearDisplay: false });
            const [isSaving, setIsSaving] = useState(false);
            const [processingMsg, setProcessingMsg] = useState('');

            useEffect(() => {
                const d = { ...initData };
                if (activeTab === 'members' && !d.type) d.type = 'master';
                // Initialize default values for new items
                if (!d.id) {
                    if (activeTab === 'projects') d.type = 'government';
                    if (activeTab === 'members') d.year = 'ç¢©ä¸€';
                    if (activeTab === 'news') d.tag = 'Activity';
                }
                setFormData(d);
                if (activeTab === 'gallery') {
                    setGalleryImages(d.src ? [{src: d.src, id: 'init'}] : []);
                    setCoverIndex(0);
                }
                setCustomInput({ year: false, role: false, classYear: false, yearDisplay: false });
            }, [initData, activeTab]);

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            
            const processFiles = async (files) => {
                setProcessingMsg(`æ­£åœ¨å£“ç¸® ${files.length} å¼µåœ–ç‰‡...`);
                setIsSaving(true);
                const processed = [];
                
                try {
                    for (const file of files) {
                        const compressedDataUrl = await compressImage(file);
                        processed.push({ src: compressedDataUrl, id: Math.random() });
                    }
                    
                    if (activeTab === 'gallery') {
                        setGalleryImages(prev => [...prev, ...processed]);
                    } else {
                        // For single image fields, take the first one
                        if (processed.length > 0) {
                            const field = activeTab === 'members' ? 'photo' : 'image';
                            setFormData(prev => ({ ...prev, [field]: processed[0].src }));
                        }
                    }
                } catch(e) {
                    alert("åœ–ç‰‡è™•ç†å¤±æ•—: " + e.message);
                }
                
                setIsSaving(false);
                setProcessingMsg('');
            };

            const handleFiles = (e) => {
                const files = Array.from(e.target.files);
                processFiles(files);
            };

            const handlePaste = (e) => {
                if (activeTab !== 'gallery') return;
                const items = e.clipboardData.items;
                const files = [];
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        files.push(items[i].getAsFile());
                    }
                }
                if (files.length > 0) processFiles(files);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                setProcessingMsg('è³‡æ–™å„²å­˜ä¸­...');
                try {
                    if (activeTab === 'gallery' && !formData.id && galleryImages.length > 0) {
                        const items = galleryImages.map((img, idx) => {
                            const offset = idx === coverIndex ? 0 : (idx + 1) * 1000;
                            return { ...formData, src: img.src, createdAt: Date.now() - offset };
                        });
                        await onBatchSave(items); 
                        onClose();
                    } else {
                        if (activeTab === 'gallery' && galleryImages.length > 0) formData.src = galleryImages[0].src;
                        await onSave(formData);
                        onClose();
                    }
                } catch (err) {
                    console.error(err);
                    alert("å„²å­˜ç™¼ç”ŸéŒ¯èª¤: " + err.message);
                } finally {
                    setIsSaving(false);
                    setProcessingMsg('');
                }
            };

            // Options
            const isMember = activeTab === 'members';
            const isGallery = activeTab === 'gallery';
            const isPI = formData.type === 'pi';
            const isAlumni = formData.type === 'alumni';
            const isStudent = ['master', 'phd'].includes(formData.type);
            const yearOptions = [];
            for (let y = 116; y >= 105; y--) yearOptions.push({ val: String(y), label: `æ°‘åœ‹ ${y} å¹´` });
            for (let y = 2030; y >= 2016; y--) yearOptions.push({ val: String(y), label: `è¥¿å…ƒ ${y} å¹´` });
            const memberClassYears = [];
            for (let y = 116; y >= 80; y--) memberClassYears.push(String(y));
            const memberYearDisplays = ["ç¢©ä¸€", "ç¢©äºŒ", "ç¢©ä¸‰", "åšä¸€", "åšäºŒ", "åšä¸‰", "åšå››", "åšäº”"];

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onPaste={handlePaste}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto relative">
                        {isSaving && (
                            <div className="absolute inset-0 bg-white/80 z-50 flex items-center justify-center flex-col">
                                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-2"></div>
                                <div className="text-blue-600 font-bold">{processingMsg}</div>
                            </div>
                        )}
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <h3 className="text-xl font-bold">{formData.id ? 'ç·¨è¼¯' : 'æ–°å¢'} {isGallery ? '(ç›¸ç°¿æ¨¡å¼)' : ''}</h3>
                            <div>
                                <label className="block text-sm font-bold mb-1">{isMember ? 'å§“å' : 'æ¨™é¡Œ'}</label>
                                <input required name={isMember ? 'name' : 'title'} value={(isMember ? formData.name : formData.title) || ''} onChange={handleChange} className="w-full border p-2 rounded" />
                                {isGallery && <p className="text-xs text-gray-500 mt-1">ç›¸åŒæ¨™é¡Œçš„ç…§ç‰‡æœƒè‡ªå‹•æ­¸é¡ç‚ºåŒä¸€æœ¬ç›¸ç°¿ã€‚</p>}
                            </div>
                            
                            {/* Member Specific Fields */}
                            {isMember && (
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-1">èº«åˆ†</label>
                                        <select name="type" value={formData.type} onChange={handleChange} className="w-full border p-2 rounded">
                                            <option value="pi">æŒ‡å°æ•™æˆ</option>
                                            <option value="phd">åšå£«ç”Ÿ</option>
                                            <option value="master">ç¢©å£«ç”Ÿ</option>
                                            <option value="alumni">ç•¢æ¥­æ ¡å‹</option>
                                        </select>
                                    </div>
                                    <div>
                                        {isAlumni ? (
                                            <>
                                                <label className="block text-sm font-bold mb-1">ç•¢æ¥­ç´šåˆ¥</label>
                                                {!customInput.classYear ? (
                                                    <select name="classYear" value={memberClassYears.includes(formData.classYear) ? formData.classYear : 'custom'} onChange={(e) => {
                                                        if(e.target.value === 'custom') setCustomInput(p => ({...p, classYear: true}));
                                                        else setFormData(p => ({...p, classYear: e.target.value}));
                                                    }} className="w-full border p-2 rounded">
                                                        <option value="" disabled>è«‹é¸æ“‡</option>
                                                        {memberClassYears.map(y => <option key={y} value={y}>{y}ç´š</option>)}
                                                        <option value="custom">è‡ªè¨‚...</option>
                                                    </select>
                                                ) : (
                                                    <div className="flex gap-2"><input name="classYear" value={formData.classYear||''} onChange={handleChange} className="w-full border p-2 rounded" placeholder="e.g. 113" /><button type="button" onClick={() => setCustomInput(p=>({...p, classYear: false}))} className="px-2 bg-gray-200 rounded text-xs">é¸å–®</button></div>
                                                )}
                                            </>
                                        ) : (isStudent && (
                                            <>
                                                <label className="block text-sm font-bold mb-1">å¹´ç´š</label>
                                                {!customInput.yearDisplay ? (
                                                    <select name="year" value={memberYearDisplays.includes(formData.year) ? formData.year : 'custom'} onChange={(e) => {
                                                        if(e.target.value === 'custom') setCustomInput(p => ({...p, yearDisplay: true}));
                                                        else setFormData(p => ({...p, year: e.target.value}));
                                                    }} className="w-full border p-2 rounded">
                                                        <option value="" disabled>è«‹é¸æ“‡</option>
                                                        {memberYearDisplays.map(y => <option key={y} value={y}>{y}</option>)}
                                                        <option value="custom">è‡ªè¨‚...</option>
                                                    </select>
                                                ) : (
                                                    <div className="flex gap-2"><input name="year" value={formData.year || ''} onChange={handleChange} placeholder="e.g. ç¢©ä¸€" className="w-full border p-2 rounded" /><button type="button" onClick={() => setCustomInput(p=>({...p, yearDisplay: false}))} className="px-2 bg-gray-200 rounded text-xs">é¸å–®</button></div>
                                                )}
                                            </>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'news' && <input type="date" name="date" value={formData.date||''} onChange={handleChange} className="w-full border p-2 rounded" />}
                            
                            {activeTab === 'projects' && (
                                <>
                                    <label className="block"><span className="text-sm font-bold">å¹´åº¦</span>
                                        {!customInput.year ? (
                                            <select name="year" value={yearOptions.some(o => o.val === formData.year) ? formData.year : 'custom'} onChange={(e) => {
                                                if(e.target.value === 'custom') setCustomInput(p => ({...p, year: true}));
                                                else setFormData(p => ({...p, year: e.target.value}));
                                            }} className="w-full border p-2 rounded mt-1"><option value="" disabled>è«‹é¸æ“‡å¹´åº¦</option>{yearOptions.map(opt => <option key={opt.val} value={opt.val}>{opt.label}</option>)}<option value="custom">è‡ªè¨‚...</option></select>
                                        ) : <div className="flex gap-2"><input name="year" value={formData.year || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1" /><button type="button" onClick={() => setCustomInput(p=>({...p, year: false}))} className="px-2 bg-gray-200 rounded mt-1 text-xs">é¸å–®</button></div>}
                                    </label>
                                    <input name="type" placeholder="é¡å‹" value={formData.type||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                    <input name="agency" placeholder="å–®ä½" value={formData.agency||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                    <input name="role" placeholder="æ“”ä»»è§’è‰²" value={formData.role||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                    <textarea name="desc" placeholder="èªªæ˜" value={formData.desc||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                </>
                            )}

                            {isGallery ? (
                                <div className="border-2 border-dashed p-4 rounded bg-gray-50">
                                    <div className="flex justify-between mb-2">
                                        <label className="font-bold text-sm">ç›¸ç°¿ç…§ç‰‡ (è‡ªå‹•å£“ç¸®)</label>
                                        <span className="text-xs bg-green-100 text-green-800 px-2 rounded">é»æ“Šè¨­ç‚ºå°é¢</span>
                                    </div>
                                    <input type="file" accept="image/*" multiple onChange={handleFiles} className="mb-2 w-full text-sm" />
                                    <div className="grid grid-cols-4 gap-2">
                                        {galleryImages.map((img, idx) => (
                                            <div key={idx} onClick={() => setCoverIndex(idx)} className={`relative aspect-square cursor-pointer border-2 ${idx===coverIndex ? 'border-green-500' : 'border-transparent'}`}>
                                                <img src={img.src} className="w-full h-full object-cover" />
                                                {idx===coverIndex && <div className="absolute top-0 left-0 bg-green-500 text-white text-[10px] px-1">å°é¢</div>}
                                                <button type="button" onClick={(e)=>{e.stopPropagation();setGalleryImages(prev=>prev.filter((_,i)=>i!==idx))}} className="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center rounded-bl">Ã—</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                ['news', 'members'].includes(activeTab) && (
                                    <div>
                                        <label className="block text-sm font-bold mb-1">åœ–ç‰‡ (è‡ªå‹•å£“ç¸®)</label>
                                        <input type="file" accept="image/*" onChange={handleFiles} className="w-full border p-2 rounded text-sm" />
                                        {formData[activeTab==='members'?'photo':'image'] && <img src={formData[activeTab==='members'?'photo':'image']} className="h-20 mt-2 border rounded" />}
                                    </div>
                                )
                            )}
                            
                            {isMember && (
                                <>
                                    <input name="research" placeholder={isPI ? 'æ ¸å¿ƒç ”ç©¶é ˜åŸŸ' : 'ç ”ç©¶ä¸»é¡Œ'} value={formData.research || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>
                                    <textarea name="researchDetail" placeholder={isPI ? 'å­¸è¡“ç°¡ä»‹' : 'è©³ç´°å…§å®¹'} value={formData.researchDetail || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1 h-20"/>
                                    <input name="email" placeholder="Email" value={formData.email || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>
                                    {isPI && <input name="phone" placeholder="é›»è©±" value={formData.phone || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>}
                                    <textarea name="awards" placeholder={isPI ? 'æ•™å­¸ç‰¹è‰²' : 'ç²çç´€éŒ„'} value={formData.awards || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>
                                </>
                            )}
                            {activeTab === 'publications' && <input name="venue" placeholder="æœŸåˆŠ/ç ”è¨æœƒ" value={formData.venue||''} onChange={handleChange} className="w-full border p-2 rounded"/>}
                            {activeTab === 'gallery' && <input name="desc" placeholder="ç›¸ç°¿æè¿°" value={formData.desc||''} onChange={handleChange} className="w-full border p-2 rounded" />}

                            <div className="flex justify-end gap-2 pt-4">
                                <button type="button" onClick={onClose} disabled={isSaving} className="px-4 py-2 border rounded disabled:opacity-50">å–æ¶ˆ</button>
                                <button type="submit" disabled={isSaving} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                    {isSaving ? 'è™•ç†ä¸­...' : 'å„²å­˜'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const ChangePasswordModal = ({ isOpen, onClose }) => {
            const [oldUser, setOldUser] = useState('');
            const [oldPass, setOldPass] = useState('');
            const [newPass, setNewPass] = useState('');
            const [confirmPass, setConfirmPass] = useState('');
            const [msg, setMsg] = useState({ type: '', text: '' });
            const handleSubmit = (e) => {
                e.preventDefault();
                const current = getCredentials();
                if (oldUser !== current.username || oldPass !== current.password) { setMsg({ type: 'error', text: 'èˆŠå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤' }); return; }
                if (newPass !== confirmPass) { setMsg({ type: 'error', text: 'å…©æ¬¡æ–°å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´' }); return; }
                if (newPass.length < 4) { setMsg({ type: 'error', text: 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€ 4 ç¢¼' }); return; }
                updateCredentials(current.username, newPass); 
                setMsg({ type: 'success', text: 'å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼' });
                setTimeout(() => { setMsg({ type: '', text: '' }); onClose(); }, 1500);
            };
            useEffect(() => { if(isOpen) { setOldUser(''); setOldPass(''); setNewPass(''); setConfirmPass(''); setMsg({type:'', text:''}); } }, [isOpen]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <h3 className="text-xl font-bold mb-4">ä¿®æ”¹ç®¡ç†å“¡å¯†ç¢¼</h3>
                        {msg.text && <div className={`p-2 mb-4 rounded text-sm ${msg.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{msg.text}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded border border-slate-200"><input type="text" placeholder="ç›®å‰çš„å¸³è™Ÿ" value={oldUser} onChange={e => setOldUser(e.target.value)} className="w-full border p-2 rounded mb-2 text-sm" required /><input type="password" placeholder="ç›®å‰çš„å¯†ç¢¼" value={oldPass} onChange={e => setOldPass(e.target.value)} className="w-full border p-2 rounded text-sm" required /></div>
                            <div className="bg-blue-50 p-3 rounded border border-blue-100"><input type="password" placeholder="æ–°å¯†ç¢¼" value={newPass} onChange={e => setNewPass(e.target.value)} className="w-full border p-2 rounded mb-2 text-sm" required /><input type="password" placeholder="ç¢ºèªæ–°å¯†ç¢¼" value={confirmPass} onChange={e => setConfirmPass(e.target.value)} className="w-full border p-2 rounded text-sm" required /></div>
                            <div className="flex justify-end space-x-3 mt-4"><button type="button" onClick={onClose} className="px-4 py-2 border rounded text-slate-600 hover:bg-slate-50">å–æ¶ˆ</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ç¢ºèªä¿®æ”¹</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const BatchImportModal = ({ isOpen, onClose, activeTab, onImport }) => {
            const [jsonInput, setJsonInput] = useState('');
            const [status, setStatus] = useState('');
            const handleImport = async () => {
                try {
                    const parsedData = JSON.parse(jsonInput);
                    if (!Array.isArray(parsedData)) throw new Error("è¼¸å…¥æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯ JSON é™£åˆ— [...]");
                    setStatus('åŒ¯å…¥ä¸­...');
                    await onImport(parsedData);
                    setStatus(`æˆåŠŸåŒ¯å…¥ ${parsedData.length} ç­†è³‡æ–™ï¼`);
                    setTimeout(() => { setStatus(''); setJsonInput(''); onClose(); }, 1500);
                } catch (e) { setStatus('éŒ¯èª¤ï¼š' + e.message); }
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
                        <h3 className="text-xl font-bold mb-2">æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™ ({activeTab})</h3>
                        <p className="text-sm text-slate-500 mb-4">è«‹è²¼ä¸Š JSON æ ¼å¼çš„é™£åˆ—è³‡æ–™ã€‚</p>
                        <textarea className="w-full h-64 border p-2 rounded font-mono text-sm" value={jsonInput} onChange={e => setJsonInput(e.target.value)} placeholder="åœ¨æ­¤è²¼ä¸Š JSON è³‡æ–™..."></textarea>
                        {status && <p className={`mt-2 text-sm ${status.includes('éŒ¯èª¤') ? 'text-red-600' : 'text-green-600'}`}>{status}</p>}
                        <div className="flex justify-end space-x-3 mt-4"><button onClick={onClose} className="px-4 py-2 border rounded">é—œé–‰</button><button onClick={handleImport} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">é–‹å§‹åŒ¯å…¥</button></div>
                    </div>
                </div>
            );
        };

        const AdminApp = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('news');
            const [dataList, setDataList] = useState([]);
            const [loading, setLoading] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [isPwdModalOpen, setIsPwdModalOpen] = useState(false);
            const [isBatchModalOpen, setIsBatchModalOpen] = useState(false);
            const [viewingAlbum, setViewingAlbum] = useState(null); 
            const [isEditorOpen, setIsEditorOpen] = useState(false);
            const [editItem, setEditItem] = useState({});
            const [forceUpdate, setForceUpdate] = useState(0);

            useEffect(() => { window.forceUpdate = () => setForceUpdate(s => s + 1); }, []);

            const albumGroups = useMemo(() => {
                if (activeTab !== 'gallery') return {};
                const groups = {};
                (dataList || []).forEach(item => {
                    const t = item.title || '(æœªå‘½å)';
                    if (!groups[t]) groups[t] = [];
                    groups[t].push(item);
                });
                return groups;
            }, [dataList, activeTab]);

            const displayList = useMemo(() => {
                if (activeTab === 'gallery' && viewingAlbum) return (dataList || []).filter(d => (d.title || '(æœªå‘½å)') === viewingAlbum);
                return dataList || [];
            }, [dataList, activeTab, viewingAlbum]);

            useEffect(() => {
                if (isLoggedIn) {
                    window.dbOps.signIn().then(() => window.dbOps.onAuth(setUser));
                }
            }, [isLoggedIn, forceUpdate]);

            useEffect(() => { if (user) loadData(); }, [activeTab, user]);

            const loadData = async () => {
                setLoading(true);
                try {
                    const list = await window.dbOps.fetch(activeTab);
                    list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    setDataList(list);
                } catch(e) { console.error(e); }
                setLoading(false);
            };

            const handleSave = async (data) => {
                try {
                    if (data.id) await window.dbOps.update(activeTab, data.id, data);
                    else await window.dbOps.add(activeTab, data);
                    loadData();
                    return true;
                } catch(e) { alert("å„²å­˜å¤±æ•—: " + e.message); throw e; }
            };

            const handleBatchSave = async (items) => {
                try { await window.dbOps.batchAdd(activeTab, items); loadData(); return true; } 
                catch(e) { alert("æ‰¹æ¬¡å„²å­˜å¤±æ•—"); return false; }
            };

            const handleDelete = async (id) => {
                if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                    await window.dbOps.delete(activeTab, id);
                    loadData();
                }
            };
            
            const ChangePwd = () => setIsPwdModalOpen(true);
            const BatchImport = () => setIsBatchModalOpen(true);
            const ResetDB = () => window.dbOps.initDefaults(defaultData).then(loadData);

            if (!isLoggedIn) return <LoginForm onLogin={() => setIsLoggedIn(true)} />;
            if (!user) return <div className="min-h-screen flex items-center justify-center text-gray-500">ç³»çµ±è¼‰å…¥ä¸­...</div>;

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <div className="w-full md:w-64 bg-slate-800 text-white p-6 flex-shrink-0">
                        <h1 className="text-xl font-bold mb-8">å¯¦é©—å®¤å¾Œå°</h1>
                        <nav className="space-y-2">
                            {Object.keys(TAB_NAMES).map(t => (
                                <button key={t} onClick={() => { setActiveTab(t); setViewingAlbum(null); }} className={`w-full text-left px-4 py-2 rounded ${activeTab===t ? 'bg-blue-600' : 'hover:bg-slate-700'}`}>{TAB_NAMES[t]}</button>
                            ))}
                        </nav>
                        <div className="mt-4 pt-4 border-t border-slate-700 space-y-2">
                             <button onClick={BatchImport} className="w-full bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-colors">ğŸ“‹ æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™</button>
                             <button onClick={ChangePwd} className="w-full bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2 rounded text-sm transition-colors">ğŸ”’ ä¿®æ”¹å¯†ç¢¼</button>
                             <button onClick={ResetDB} className="w-full bg-slate-500 hover:bg-slate-600 text-white px-4 py-2 rounded text-sm transition-colors">åˆå§‹åŒ–/é‡ç½®è³‡æ–™åº«</button>
                        </div>
                    </div>
                    
                    <div className="flex-grow p-8 overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold flex items-center gap-2">
                                {activeTab === 'gallery' && viewingAlbum && <button onClick={() => setViewingAlbum(null)} className="text-blue-500 hover:underline">â†</button>}
                                {activeTab === 'gallery' && viewingAlbum ? viewingAlbum : TAB_NAMES[activeTab]}
                            </h2>
                            <button onClick={() => { setEditItem(viewingAlbum ? {title: viewingAlbum} : {}); setIsEditorOpen(true); }} className="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">+ æ–°å¢</button>
                        </div>

                        {loading ? <p>è¼‰å…¥ä¸­...</p> : (
                            <div className="bg-white rounded shadow p-6">
                                {activeTab === 'gallery' && !viewingAlbum ? (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {Object.entries(albumGroups).map(([title, items]) => (
                                            <div key={title} onClick={() => setViewingAlbum(title)} className="border rounded p-4 cursor-pointer hover:bg-blue-50 flex flex-col items-center text-center">
                                                <FolderIcon />
                                                <span className="font-bold">{title}</span>
                                                <span className="text-xs text-gray-500">{items.length} å¼µ</span>
                                            </div>
                                        ))}
                                        {Object.keys(albumGroups).length === 0 && <p className="col-span-full text-center text-gray-400">å°šç„¡ç›¸ç°¿</p>}
                                    </div>
                                ) : (
                                    <table className="w-full text-left">
                                        <thead><tr className="border-b text-gray-500"><th className="p-3">æ¨™é¡Œ / å…§å®¹</th><th className="p-3">æ“ä½œ</th></tr></thead>
                                        <tbody>
                                            {displayList.map(item => (
                                                <tr key={item.id} className="border-b hover:bg-gray-50">
                                                    <td className="p-3">
                                                        <div className="font-bold">{item.title || item.name}</div>
                                                        <div className="text-xs text-gray-500 truncate max-w-md">{item.desc || item.research}</div>
                                                        {(item.src || item.photo || item.image) && <span className="text-[10px] bg-green-100 text-green-800 px-1 rounded">IMG</span>}
                                                    </td>
                                                    <td className="p-3">
                                                        <button onClick={() => { setEditItem(item); setIsEditorOpen(true); }} className="text-blue-600 mr-3">ç·¨è¼¯</button>
                                                        <button onClick={() => handleDelete(item.id)} className="text-red-600">åˆªé™¤</button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {displayList.length === 0 && <tr><td colSpan="2" className="p-4 text-center text-gray-400">ç„¡è³‡æ–™</td></tr>}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {isEditorOpen && <EditorModal activeTab={activeTab} initData={editItem} onSave={handleSave} onBatchSave={handleBatchSave} onClose={() => setIsEditorOpen(false)} />}
                    <ChangePasswordModal isOpen={isPwdModalOpen} onClose={() => setIsPwdModalOpen(false)} />
                    <BatchImportModal isOpen={isBatchModalOpen} onClose={() => setIsBatchModalOpen(false)} activeTab={activeTab} onImport={handleBatchSave} />
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><AdminApp /></ErrorBoundary>);
    </script>
</body>
</html>